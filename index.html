<!DOCTYPE html>
<html>
<head>
    <title>Calcular Controle de Domínio do BPA</title>
    <!-- Adicione os links CDN do Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Calcular Controle de Domínio do BPA</h1>
        <input type="file" id="fileInput" />
        <br /><br />

        <!-- Adicione a barra de progresso -->
        <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>

        <!-- Exibir o Controle de Domínio -->
        <div class="mt-4">
            <strong>Controle de Domínio:</strong>
            <span id="domainControl">-</span>
        </div>

        <!-- Botão para download do arquivo -->
        <a class="btn btn-primary mt-3" id="downloadButton" style="display: none;">Baixar Arquivo</a>
    </div>

    <!-- Adicione o script do Bootstrap (opcional, se necessário) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function calculateResult(code, quantity) {
            return parseInt(code) + parseInt(quantity);
        }

        function generateNewCode(lines, domainControl, fileName) {
            let contentWithControl = '';

            for (let i = 0; i < lines.length; i++) {
                const lineType = lines[i].substring(0, 2);

                if (lineType === '02' || lineType === '03') {
                    // Mantém as linhas iniciadas em '02' ou '03' sem alterações
                    contentWithControl += lines[i] + '\n';
                } else if (lineType === '01') {
                    contentWithControl += lines[i].substring(0, 26); // Mantém os primeiros 26 caracteres
                    contentWithControl += domainControl.toString().padStart(4, '0'); // Adiciona o Controle de Domínio
                    contentWithControl += lines[i].substring(30) + '\n'; // Mantém o restante da linha
                }
            }

            // Cria o arquivo para download
            const blob = new Blob([contentWithControl], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const downloadButton = document.getElementById('downloadButton');
            downloadButton.href = url;
            downloadButton.download = fileName;
            downloadButton.style.display = 'block';

            // Exibe o Controle de Domínio na página
            document.getElementById('domainControl').textContent = domainControl;
        }

        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            const reader = new FileReader();

            reader.onloadstart = function () {
                document.querySelector('.progress-bar').style.width = '0%';
                document.querySelector('.progress-bar').textContent = '0%';
            };

            reader.onprogress = function (e) {
                if (e.lengthComputable) {
                    const percentLoaded = Math.round((e.loaded / e.total) * 100);
                    document.querySelector('.progress-bar').style.width = percentLoaded + '%';
                    document.querySelector('.progress-bar').textContent = percentLoaded + '%';
                }
            };

            reader.onload = function (e) {
                const content = e.target.result;
                const lines = content.split('\n');

                // Somar todos os resultados para calcular o Controle de Domínio
                let totalResults = 0;
                for (let i = 0; i < lines.length; i++) {
                    const lineType = lines[i].substring(0, 2);
                    if (lineType === '02' || lineType === '03') {
                        const lineLength = lines[i].length;
                        const difference = lineType === '02' ? lineLength - 40 : lineLength - 340;
                        const procedureCode = lines[i].substring(26 + difference, 36 + difference).trim();
                        const quantity = lines[i].substring(39 + difference, 45 + difference).trim();
                        if (procedureCode && quantity) {
                            const result = calculateResult(procedureCode, quantity);
                            totalResults += result;
                        }
                    }
                }

                // Calcular o Controle de Domínio e gerar o arquivo com o Controle de Domínio inserido
                const domainControl = (totalResults % 1111) + 1111;
                generateNewCode(lines, domainControl, file.name);
            };

            reader.readAsText(file);
        }
    </script>
</body>
</html>
